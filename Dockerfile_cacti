FROM php:7.4.33-apache

RUN apt-get update && \
    apt-get install -y \
        git \
        rrdtool \
        mariadb-server \
        snmp \
        snmpd \
        libsnmp-dev \
        libxml2-dev \
        libonig-dev \
        libpng-dev \
        libgmp-dev \
        libzip-dev \
        libldap2-dev

RUN docker-php-ext-install mysqli pdo pdo_mysql sockets snmp xml mbstring json gd gmp zip ldap gettext
RUN docker-php-ext-enable mysqli pdo pdo_mysql sockets snmp xml mbstring json gd gmp zip ldap gettext

COPY ./config/cacti/php.ini /usr/local/etc/php/conf.d/php.ini

RUN git clone --depth 1 -b release/1.2.22 https://github.com/Cacti/cacti.git

# Move every default path for write stuff under '/tmp', i.e. the only writable directory.
RUN mv /var/www/html/cacti/lib/functions.php /var/www/html/cacti/lib/functions.php.bak
COPY ./config/cacti/functions.php /var/www/html/cacti/lib/functions.php
RUN mv /var/www/html/cacti/include/global_settings.php /var/www/html/cacti/include/global_settings.php.bak
COPY ./config/cacti/global_settings.php /var/www/html/cacti/include/global_settings.php

COPY ./config/cacti/config.php /var/www/html/cacti/include/config.php

RUN echo "*/5 * * * * apache php /var/www/html/cacti/poller.php &>/dev/null" > /etc/cron.d/cacti
